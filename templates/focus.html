<!DOCTYPE html>
<html lang="{{ lang }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t['app_name'] }} - Focus</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        .timer-container {
            position: relative;
            width: 220px;
            height: 220px;
            margin: 2rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .timer-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .timer-bg {
            fill: none;
            stroke: #334155;
            stroke-width: 4;
        }

        .timer-progress {
            fill: none;
            stroke: var(--accent);
            stroke-width: 4;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s ease;
            filter: drop-shadow(0 0 6px var(--accent));
        }

        .timer-text-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #timerDisplay {
            font-size: 2.5rem;
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            margin-bottom: -0.25rem;
        }

        #timerLabel {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.1rem;
            font-weight: 500;
        }

        /* Distraction Shield */
        .shield-dim {
            transition: opacity 0.5s ease, filter 0.5s ease;
        }

        body.focus-active .shield-dim {
            opacity: 0.15;
            filter: blur(2px);
            pointer-events: none;
        }

        body.focus-active .shield-dim:hover {
            opacity: 0.4;
            filter: blur(0);
            pointer-events: auto;
        }

        .focus-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            justify-content: space-between;
            transition: all 0.5s ease;
        }

        body.focus-active .focus-config {
            display: none;
        }

        body.focus-active .card {
            border-color: transparent;
        }
    </style>
</head>

<body>
    <div class="container">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 2rem;"
            class="shield-dim">
            <h1>
                {{ t['focus_title_task'] }} â€” {{ task.description }}
            </h1>
            <a href="/dashboard/{{ session.id }}" class="btn btn-secondary">{{ t['back'] }}</a>
        </div>

        <div class="card">
            <div class="focus-controls">
                <div class="focus-config" style="display:flex; flex-wrap:wrap; gap:1rem; align-items:center;">
                    <div style="display:flex; flex-direction:column; gap:0.5rem;">
                        <label style="color: var(--text-secondary);">{{ t['pomodoro'] }}</label>
                        <select id="pomodoroSelect" class="input-field" style="padding:0.4rem 0.6rem; width:auto;">
                            <option value="off">{{ t['pomodoro_off'] }}</option>
                            <option value="50/10">{{ t['pomodoro_50_10'] }}</option>
                            <option value="75/15">{{ t['pomodoro_75_15'] }}</option>
                        </select>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:0.5rem;">
                        <label style="color: var(--text-secondary);">{{ t['focus_note'] }}</label>
                        <input id="focusNote" type="text" class="input-field"
                            style="padding:0.4rem 0.6rem; width:220px;">
                    </div>
                </div>
                <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-left: auto;">
                    <button class="btn" id="startBtn" onclick="startFocus()">{{ t['start_focus'] }}</button>
                    <button class="btn btn-secondary" id="pauseBtn" onclick="togglePause()">{{ t['pause_focus']
                        }}</button>
                    <button class="btn btn-secondary" id="stopBtn" onclick="stopFocus()">{{ t['stop_focus'] }}</button>
                </div>
            </div>

            <div class="timer-container">
                <svg class="timer-svg" viewBox="0 0 100 100">
                    <circle class="timer-bg" cx="50" cy="50" r="46" />
                    <circle id="timerProgress" class="timer-progress" cx="50" cy="50" r="46" stroke-dasharray="290"
                        stroke-dashoffset="290" />
                </svg>
                <div class="timer-text-container">
                    <div id="timerDisplay">00:00:00</div>
                    <div id="timerLabel"></div>
                </div>
            </div>
        </div>

        <div class="card shield-dim">
            <h3 style="margin-bottom: 1rem;">{{ t['focus_history'] }}</h3>
            <div style="display:flex; flex-direction:column; gap:1rem;">
                {% for row in focus_rows %}
                <div class="focus-entry" data-date="{{ session.date.strftime('%Y-%m-%d') }}"
                    data-focus-id="{{ row.id }}" style="border:1px solid #334155; border-radius:10px; padding:0.75rem;">
                    <div style="display:flex; flex-wrap:wrap; gap:0.5rem; align-items:flex-end;">
                        <div style="display:flex; flex-direction:column; gap:0.25rem;">
                            <label style="color:var(--text-secondary); font-size:0.85rem;">{{ t['start'] }}</label>
                            <input type="text" class="time-input focus-start-input" placeholder="HH:MM" maxlength="5"
                                value="{{ row.start_time }}">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.25rem;">
                            <label style="color:var(--text-secondary); font-size:0.85rem;">{{ t['end'] }}</label>
                            <input type="text" class="time-input focus-end-input" placeholder="HH:MM" maxlength="5"
                                value="{{ row.end_time }}">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.25rem; flex:1; min-width:160px;">
                            <label style="color:var(--text-secondary); font-size:0.85rem;">{{ t['note'] }}</label>
                            <input type="text" class="input-field focus-note-input" style="padding:0.3rem 0.5rem;"
                                value="{{ row.note }}">
                        </div>
                        <div style="display:flex; flex-direction:column; gap:0.25rem;">
                            <label style="color:var(--text-secondary); font-size:0.85rem;">{{ t['pomodoro'] }}</label>
                            <select class="input-field focus-pomodoro-select"
                                style="padding:0.3rem 0.5rem; min-width:80px;">
                                <option value="off">{{ t['pomodoro_off'] }}</option>
                                <option value="50/10" {% if row.pomodoro=='50/10' %}selected{% endif %}>{{
                                    t['pomodoro_50_10'] }}</option>
                                <option value="75/15" {% if row.pomodoro=='75/15' %}selected{% endif %}>{{
                                    t['pomodoro_75_15'] }}</option>
                            </select>
                        </div>
                    </div>

                    <div
                        style="display:flex; flex-wrap:wrap; gap:0.75rem; margin-top:0.5rem; color:var(--text-secondary); align-items:center;">
                        <div>{{ t['focus_work'] }}: <strong style="color:var(--text-primary);">{{ row.work }}</strong>
                        </div>
                        <div style="display:flex; align-items:center; gap:0.4rem;">
                            {{ t['focus_pause'] }}:
                            <input type="text" class="time-input focus-pause-total" style="width: 100px;"
                                placeholder="H:MM:SS" maxlength="8" value="{{ row.pause_total }}">
                        </div>
                        <div>{{ t['focus_total'] }}: <strong style="color:var(--text-primary);">{{ row.total }}</strong>
                        </div>
                    </div>

                    <div style="display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:0.5rem;">
                        <button type="button" class="btn btn-secondary" style="padding:0.25rem 0.7rem;"
                            onclick="deleteFocusRow({{ row.id }})">{{ t['focus_delete'] }}</button>
                    </div>

                </div>
                {% else %}
                <div style="text-align:center; padding: 1.5rem;">-</div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        const SESSION_ID = {{ session.id }};
        const TASK_ID = {{ task.id if task else 'null' }};
        const ACTIVE_FOCUS_ID = {{ active_focus.id if active_focus else 'null' }};
        const ACTIVE_PAUSE = {{ 'true' if active_focus and active_focus.active_pause else 'false' }};
        const ACTIVE_POMODORO = {{ (active_focus.pomodoro if active_focus else '') | tojson }};
        const ACTIVE_NOTE = {{ (active_focus.note if active_focus else '') | tojson }};
        const ACTIVE_START_ISO = {{ (active_focus.start_iso if active_focus else '') | tojson }};
        const ACTIVE_PAUSE_SECONDS = {{ active_focus.pause_seconds if active_focus else 0 }};

        let timerInterval = null;
        let pausedAt = ACTIVE_PAUSE ? Date.now() : null;
        const activeStart = ACTIVE_START_ISO ? new Date(ACTIVE_START_ISO) : null;

        function parsePomodoro(value) {
            if (!value || value === 'off') return null;
            const parts = value.split('/');
            if (parts.length !== 2) return null;
            const work = parseInt(parts[0], 10);
            const rest = parseInt(parts[1], 10);
            if (isNaN(work) || isNaN(rest)) return null;
            return { work, rest };
        }

        function updateTimerDisplay(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            document.getElementById('timerDisplay').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // Update Progress Bar
            const progressCircle = document.getElementById('timerProgress');
            const circumference = 2 * Math.PI * 46; // r=46

            if (ACTIVE_POMODORO) {
                const config = parsePomodoro(ACTIVE_POMODORO);
                if (config) {
                    const targetSeconds = config.work * 60;
                    const percentage = Math.min(totalSeconds / targetSeconds, 1);
                    const offset = circumference - (percentage * circumference);
                    progressCircle.style.strokeDasharray = circumference;
                    progressCircle.style.strokeDashoffset = offset;

                    // Change color if over time?
                    if (totalSeconds >= targetSeconds) {
                        progressCircle.style.stroke = 'var(--success)';
                    } else {
                        progressCircle.style.stroke = 'var(--accent)';
                    }
                }
            } else {
                // If no pomodoro, maybe just a slow circular pulse or 1-hour wrap
                const percentage = (totalSeconds % 3600) / 3600;
                const offset = circumference - (percentage * circumference);
                progressCircle.style.strokeDasharray = circumference;
                progressCircle.style.strokeDashoffset = offset;
                progressCircle.style.stroke = 'var(--accent)';
            }
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function requestNotificationPermission() {
            if (!('Notification' in window)) return;
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function notifyUser(title, body) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, { body });
            } else {
                alert(body);
            }
        }

        function getPausedSeconds() {
            if (!ACTIVE_PAUSE || !pausedAt) return ACTIVE_PAUSE_SECONDS;
            return ACTIVE_PAUSE_SECONDS + Math.floor((Date.now() - pausedAt) / 1000);
        }

        function startLiveCounter() {
            if (!activeStart) {
                updateTimerDisplay(0);
                return;
            }
            stopTimer();
            timerInterval = setInterval(() => {
                const elapsed = Math.max(0, Math.floor((Date.now() - activeStart) / 1000) - getPausedSeconds());
                updateTimerDisplay(elapsed);
                // Pomodoro break notification
                if (ACTIVE_POMODORO) {
                    const config = parsePomodoro(ACTIVE_POMODORO);
                    if (config && elapsed === (config.work * 60)) {
                        notifyUser('Pomodoro', `Break time: ${config.rest} min`);
                    }
                }
            }, 1000);
        }

        async function startFocus() {
            const pomodoro = document.getElementById('pomodoroSelect').value;
            const note = document.getElementById('focusNote').value.trim();
            const res = await fetch('/api/focus/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    session_id: SESSION_ID,
                    task_id: TASK_ID,
                    pomodoro_mode: pomodoro !== 'off' ? pomodoro : null,
                    note: note || null
                })
            });
            if (res.ok) {
                window.location.reload();
            } else {
                const data = await res.json();
                alert(data.error || 'Failed to start focus');
            }
        }

        async function stopFocus() {
            if (!ACTIVE_FOCUS_ID) return;
            const res = await fetch('/api/focus/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ focus_session_id: ACTIVE_FOCUS_ID })
            });
            if (res.ok) {
                stopTimer();
                window.location.reload();
            } else {
                alert('Failed to stop focus');
            }
        }

        async function togglePause() {
            if (!ACTIVE_FOCUS_ID) return;
            const endpoint = ACTIVE_PAUSE ? '/api/focus/pause/end' : '/api/focus/pause/start';
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ focus_session_id: ACTIVE_FOCUS_ID })
            });
            if (res.ok) {
                window.location.reload();
            } else {
                alert('Failed to toggle pause');
            }
        }

        function initFocusUi() {
            requestNotificationPermission();
            if (ACTIVE_POMODORO) {
                document.getElementById('pomodoroSelect').value = ACTIVE_POMODORO;
            }
            if (ACTIVE_NOTE) {
                document.getElementById('focusNote').value = ACTIVE_NOTE;
            }
            if (ACTIVE_PAUSE) {
                document.getElementById('pauseBtn').textContent = "{{ t['resume_focus'] }}";
            }
            if (ACTIVE_FOCUS_ID) {
                document.body.classList.add('focus-active');
                document.getElementById('startBtn').style.display = 'none';
            }
            if (ACTIVE_POMODORO) {
                const config = parsePomodoro(ACTIVE_POMODORO);
                if (config) {
                    document.getElementById('timerLabel').textContent = `${config.work} min`;
                }
            }
            startLiveCounter();
        }

        function normalizeTimeInput(value) {
            if (!value) return null;
            const trimmed = value.trim();
            const onlyHours = trimmed.match(/^([01]?\d|2[0-3])$/);
            if (onlyHours) {
                const h = onlyHours[1].padStart(2, '0');
                return `${h}:00`;
            }
            const withColon = trimmed.match(/^([01]?\d|2[0-3]):([0-5]?\d)$/);
            if (withColon) {
                const h = withColon[1].padStart(2, '0');
                const m = withColon[2].padStart(2, '0');
                return `${h}:${m}`;
            }
            return null;
        }

        function normalizeDurationInput(value) {
            if (!value) return null;
            const trimmed = value.trim();
            const minutesOnly = trimmed.match(/^\d+$/);
            if (minutesOnly) {
                const m = minutesOnly[0].padStart(2, '0');
                return `00:${m}:00`;
            }
            const mmss = trimmed.match(/^(\d{1,2}):([0-5]?\d)$/);
            if (mmss) {
                const m = mmss[1].padStart(2, '0');
                const s = mmss[2].padStart(2, '0');
                return `00:${m}:${s}`;
            }
            const hhmmss = trimmed.match(/^(\d{1,2}):([0-5]?\d):([0-5]?\d)$/);
            if (hhmmss) {
                const h = hhmmss[1].padStart(2, '0');
                const m = hhmmss[2].padStart(2, '0');
                const s = hhmmss[3].padStart(2, '0');
                return `${h}:${m}:${s}`;
            }
            return null;
        }

        async function saveFocusPauseTotal(row) {
            const focusId = row.getAttribute('data-focus-id');
            const input = row.querySelector('.focus-pause-total');
            const duration = normalizeDurationInput(input.value);
            if (duration) input.value = duration;

            const res = await fetch('/api/focus/pause_total', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    focus_session_id: focusId,
                    duration: duration
                })
            });

            if (res.ok) {
                // Visual feedback
                const originalColor = input.style.color;
                input.style.color = 'var(--success)';
                setTimeout(() => {
                    input.style.color = originalColor;
                }, 500);
            } else {
                const data = await res.json();
                alert(data.error || 'Failed to save');
            }
        }

        async function saveFocusRow(row) {
            const focusId = row.getAttribute('data-focus-id');
            const inputs = row.querySelectorAll('input, select');
            const rowDate = row.getAttribute('data-date');

            const startInput = row.querySelector('.focus-start-input');
            const endInput = row.querySelector('.focus-end-input');
            const noteInput = row.querySelector('.focus-note-input');
            const pomodoroSelect = row.querySelector('.focus-pomodoro-select');

            const startTime = normalizeTimeInput(startInput.value);
            const endTime = normalizeTimeInput(endInput.value);
            const note = noteInput.value;
            const pomodoro = pomodoroSelect.value;

            if (startTime) startInput.value = startTime;
            if (endTime) endInput.value = endTime;

            const res = await fetch('/api/focus/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    focus_session_id: focusId,
                    start_date: rowDate,
                    start_time: startTime,
                    end_date: rowDate,
                    end_time: endTime,
                    note,
                    pomodoro_mode: pomodoro
                })
            });

            if (res.ok) {
                // Visual feedback for inputs
                [startInput, endInput, noteInput].forEach(input => {
                    const originalColor = input.style.color;
                    input.style.color = 'var(--success)';
                    setTimeout(() => input.style.color = originalColor, 500);
                });
            } else {
                const data = await res.json();
                alert(data.error || 'Failed to save');
            }
        }

        async function deleteFocusRow(focusId) {
            if (!confirm('{{ t["confirm_delete"] }}')) return;
            const res = await fetch('/api/focus/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ focus_session_id: focusId })
            });
            if (res.ok) {
                const element = document.querySelector(`.focus-entry[data-focus-id="${focusId}"]`);
                if (element) {
                    element.style.opacity = '0';
                    element.style.transform = 'translateY(10px)';
                    setTimeout(() => element.remove(), 300);
                }
            } else {
                alert('Failed to delete');
            }
        }

        function wireAutoSave() {
            document.querySelectorAll('.focus-entry').forEach(row => {
                const inputs = row.querySelectorAll('.focus-start-input, .focus-end-input, .focus-note-input');
                const select = row.querySelector('.focus-pomodoro-select');
                const pauseInput = row.querySelector('.focus-pause-total');

                inputs.forEach(input => {
                    input.addEventListener('blur', () => saveFocusRow(row));
                });
                if (select) {
                    select.addEventListener('change', () => saveFocusRow(row));
                }
                if (pauseInput) {
                    pauseInput.addEventListener('blur', () => saveFocusPauseTotal(row));
                }
            });
        }

        function setupTimeInputs() {
            document.querySelectorAll('.time-input').forEach(input => {
                input.addEventListener('input', function (e) {
                    const isDuration = input.classList.contains('focus-pause-total');
                    let val = e.target.value.replace(/\D/g, '');
                    const maxDigits = isDuration ? 6 : 4;
                    if (val.length > maxDigits) val = val.slice(0, maxDigits);

                    let formatted = '';
                    if (val.length > 0) {
                        // Hours (or MM in MM:SS)
                        formatted = val.slice(0, 2);
                        if (!isDuration && parseInt(formatted) > 23) formatted = "23";

                        if (val.length > 2) {
                            // Minutes (or SS in MM:SS)
                            let m = val.slice(2, 4);
                            if (parseInt(m) > 59) m = "59";
                            formatted += ":" + m;

                            if (isDuration && val.length > 4) {
                                // Seconds
                                let s = val.slice(4, 6);
                                if (parseInt(s) > 59) s = "59";
                                formatted += ":" + s;
                            }
                        } else if (val.length === 2 && e.inputType !== 'deleteContentBackward') {
                            formatted += ":";
                        }
                    }
                    e.target.value = formatted;
                });

                input.addEventListener('keydown', function (e) {
                    if (e.key === 'Backspace' && e.target.value.endsWith(':')) {
                        e.preventDefault();
                        e.target.value = e.target.value.slice(0, -2);
                    }
                });

                // Trigger change on enter
                input.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        e.target.blur();
                    }
                });
            });
        }

        initFocusUi();
        wireAutoSave();
        setupTimeInputs();
    </script>
</body>

</html>