<!DOCTYPE html>
<html lang="de-CH">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - LeTempsEstCompté</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>

<body>
    <div class="container">

        <div class="dashboard-header">
            <div class="goal-display">
                <h2>Today's Goal</h2>
                <div id="editableGoal" class="goal-text" contenteditable="true"
                    style="border-bottom: 1px dashed var(--text-secondary); outline: none;" onblur="updateGoal()">{{
                    session.goal }}</div>
            </div>
            <div style="display:flex; flex-direction:column; align-items:flex-end; gap:0.5rem;">
                <div class="date-display" style="color: var(--text-secondary);">
                    {{ session.date.strftime('%B %d, %Y') }}
                </div>
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <label for="statusSelect" style="color: var(--text-secondary); font-size:0.9rem;">Status</label>
                    <select id="statusSelect" class="input-field" style="padding:0.4rem 0.6rem; width:auto;"
                        onchange="updateStatus()">
                        <option value="work" {% if session.status == 'work' %}selected{% endif %}>Arbeit</option>
                        <option value="sick" {% if session.status == 'sick' %}selected{% endif %}>Krank</option>
                        <option value="vacation" {% if session.status == 'vacation' %}selected{% endif %}>Urlaub</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 1.5rem;">Tasks</h3>

            <div class="input-group" style="display: flex; gap: 1rem; margin-bottom: 1.5rem;">
                <input type="text" id="newTaskInput" class="input-field" placeholder="Add a new task..."
                    style="margin-bottom: 0;">
                <button id="addTaskBtn" class="btn" style="white-space: nowrap;">Add Task</button>
            </div>

            <ul id="taskList" class="task-list">
                {% for task in session.tasks %}
                <li class="task-item {% if task.is_completed %}completed{% endif %}" data-id="{{ task.id }}">
                    <div class="checkbox" onclick="toggleTask('{{ task.id }}')"></div>
                    <span class="task-text" contenteditable="true"
                        onblur="updateTaskDescription('{{ task.id }}', this.innerText)">{{ task.description }}</span>
                    <button onclick="deleteTask('{{ task.id }}')" class="btn btn-secondary"
                        style="padding: 0.2rem 0.5rem; font-size: 0.75rem; margin-left: auto;">✕</button>
                </li>
                {% endfor %}
            </ul>
        </div>

        <div class="controls-grid">
            <div class="card control-card">
                <h3>Pauses</h3>
                <div id="pausesList" style="margin: 1rem 0; width: 100%;">
                    {% for pause in session.pauses %}
                    <div class="pause-item" data-pause-id="{{ pause.id }}"
                        style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <input type="text" class="time-input time-text-input pause-start"
                            value="{{ pause.start_time.strftime('%H:%M') if pause.start_time else '' }}"
                            placeholder="HH:MM" inputmode="numeric" pattern="^([01]\d|2[0-3]):[0-5]\d$"
                            onblur="formatTimeInput(this); updatePause('{{ pause.id }}', 'start', this)"
                            onchange="updatePause('{{ pause.id }}', 'start', this)"
                            data-date="{{ session.date.strftime('%Y-%m-%d') }}" style="flex: 1;">
                        <span style="color: var(--text-secondary);">→</span>
                        <input type="text" class="time-input time-text-input pause-end"
                            value="{{ pause.end_time.strftime('%H:%M') if pause.end_time else '' }}"
                            placeholder="HH:MM" inputmode="numeric" pattern="^([01]\d|2[0-3]):[0-5]\d$"
                            onblur="formatTimeInput(this); updatePause('{{ pause.id }}', 'end', this)"
                            onchange="updatePause('{{ pause.id }}', 'end', this)"
                            data-date="{{ session.date.strftime('%Y-%m-%d') }}" style="flex: 1;">
                        <button onclick="deletePause('{{ pause.id }}')" class="btn btn-secondary"
                            style="padding: 0.3rem 0.6rem; font-size: 0.8rem;">✕</button>
                    </div>
                    {% endfor %}
                </div>
                <button id="addPauseBtn" onclick="addPause()" class="btn btn-secondary" style="width: 100%;">+ Add
                    Pause</button>
            </div>

            <div class="card control-card">
                <h3>Hours</h3>
                <div
                    style="display: flex; flex-direction: column; gap: 1rem; width: 100%; align-items: center; margin-top: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <label>Start:</label>
                        <input type="text" id="startTimeInput" class="time-input time-text-input"
                            value="{{ session.start_time.strftime('%H:%M') if session.start_time else '' }}"
                            placeholder="HH:MM" inputmode="numeric" pattern="^([01]\d|2[0-3]):[0-5]\d$"
                            onblur="formatTimeInput(this); updateTime('start', this)"
                            onchange="updateTime('start', this)"
                            data-date="{{ session.date.strftime('%Y-%m-%d') }}">
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <label>End:</label>
                        <input type="text" id="endTimeInput" class="time-input time-text-input"
                            value="{{ session.end_time.strftime('%H:%M') if session.end_time else '' }}"
                            placeholder="HH:MM" inputmode="numeric" pattern="^([01]\d|2[0-3]):[0-5]\d$"
                            onblur="formatTimeInput(this); updateTime('end', this)"
                            onchange="updateTime('end', this)"
                            data-date="{{ session.date.strftime('%Y-%m-%d') }}">
                    </div>
                    <div id="totalWorkRow"
                        style="display:flex; align-items:center; gap:0.75rem; color: var(--text-secondary);">
                        <span>Total:</span>
                        <strong id="totalWorkDisplay" style="color: var(--text-primary);">--:--</strong>
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-top: 3rem; display: flex; justify-content: center;">
            <a href="/" class="btn btn-secondary" style="padding: 0.75rem 2rem; font-weight: 600;">
                Save & Return to Homepage
            </a>
        </div>
    </div>

    <script>
        const SESSION_ID = '{{ session.id }}';
        const INITIAL_STATUS = '{{ session.status }}';

        async function updateGoal() {
            const goalEl = document.getElementById('editableGoal');
            const newGoal = goalEl.innerText.trim();

            // Optional: visual feedback
            const originalColor = goalEl.style.color;

            try {
                const res = await fetch('/api/session/update_goal', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: SESSION_ID, goal: newGoal })
                });

                if (res.ok) {
                    goalEl.style.color = 'var(--success)';
                    setTimeout(() => goalEl.style.color = '', 1000); // Reset after 1s
                } else {
                    alert('Failed to update goal');
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function updateTaskDescription(taskId, newDescription) {
            const res = await fetch('/api/task/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_id: taskId, description: newDescription })
            });

            if (!res.ok) {
                alert('Failed to update task');
            }
        }

        async function deleteTask(taskId) {
            if (!confirm('Delete this task?')) return;

            const res = await fetch('/api/task/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_id: taskId })
            });

            if (res.ok) {
                const li = document.querySelector(`.task-item[data-id="${taskId}"]`);
                if (li) li.remove();
            } else {
                alert('Failed to delete task');
            }
        }

        async function updateTime(type, inputEl) {
            if (!inputEl) return;
            const dateStr = inputEl.getAttribute('data-date'); // YYYY-MM-DD

            const payload = { session_id: SESSION_ID };
            if (inputEl.value) {
                const normalized = normalizeTimeInput(inputEl.value);
                if (!normalized) return;
                inputEl.value = normalized;
                const dateTimeStr = `${dateStr}T${normalized}:00`;
                if (type === 'start') payload.start_time = dateTimeStr;
                if (type === 'end') payload.end_time = dateTimeStr;
            } else {
                if (type === 'end') payload.end_time = null;
                else return; // Don't allow clearing start time
            }

            const res = await fetch('/api/session/update_times', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                // Visual feedback
                const originalColor = inputEl.style.color;
                inputEl.style.color = 'var(--success)';
                setTimeout(() => inputEl.style.color = originalColor, 1000);
                updateTotalWork();
            } else {
                alert('Failed to update time');
            }
        }

        const SESSION_DATE = "{{ session.date.strftime('%Y-%m-%d') }}";

        async function addPause() {
            const res = await fetch('/api/pause/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: SESSION_ID })
            });

            if (res.ok) {
                const data = await res.json();
                // Reload to show new pause row
                window.location.reload();
            } else {
                alert('Failed to add pause');
            }
        }

        async function updatePause(pauseId, type, inputEl) {
            if (!inputEl) return;
            const dateStr = inputEl.getAttribute('data-date');

            if (!dateStr || !inputEl.value) return;

            const normalized = normalizeTimeInput(inputEl.value);
            if (!normalized) return;
            inputEl.value = normalized;
            const dateTimeStr = `${dateStr}T${normalized}:00`;

            const payload = { pause_id: pauseId };
            if (type === 'start') payload.start_time = dateTimeStr;
            if (type === 'end') payload.end_time = dateTimeStr;

            const res = await fetch('/api/pause/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                const originalColor = inputEl.style.color;
                inputEl.style.color = 'var(--success)';
                setTimeout(() => inputEl.style.color = originalColor, 1000);
                updateTotalWork();
            } else {
                alert('Failed to update pause');
            }
        }

        async function deletePause(pauseId) {
            if (!confirm('Delete this pause?')) return;

            const res = await fetch('/api/pause/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pause_id: pauseId })
            });

            if (res.ok) {
                // Remove the row from DOM
                const row = document.querySelector(`[data-pause-id="${pauseId}"]`);
                if (row) row.remove();
            } else {
                alert('Failed to delete pause');
            }
        }

        function applyStatusUi(status) {
            const timeInputs = document.querySelectorAll('.time-input');
            const pauseRows = document.querySelectorAll('.pause-item');
            const addPauseBtn = document.getElementById('addPauseBtn');

            const isWork = status === 'work';
            timeInputs.forEach(input => {
                input.disabled = !isWork;
                if (!isWork) input.value = '';
            });
            pauseRows.forEach(row => {
                row.style.display = isWork ? '' : 'none';
            });
            if (addPauseBtn) addPauseBtn.disabled = !isWork;
        }

        function normalizeTimeInput(value) {
            if (!value) return null;
            const trimmed = value.trim();
            const onlyHours = trimmed.match(/^([01]?\d|2[0-3])$/);
            if (onlyHours) {
                const h = onlyHours[1].padStart(2, '0');
                return `${h}:00`;
            }
            const withColon = trimmed.match(/^([01]?\d|2[0-3]):([0-5]?\d)$/);
            if (withColon) {
                const h = withColon[1].padStart(2, '0');
                const m = withColon[2].padStart(2, '0');
                return `${h}:${m}`;
            }
            return null;
        }

        function timeToMinutes(value) {
            const normalized = normalizeTimeInput(value);
            if (!normalized) return null;
            const [h, m] = normalized.split(':').map(Number);
            return (h * 60) + m;
        }

        function updateTotalWork() {
            const startInput = document.getElementById('startTimeInput');
            const endInput = document.getElementById('endTimeInput');
            const display = document.getElementById('totalWorkDisplay');
            if (!display || !startInput || !endInput) return;

            const startMin = timeToMinutes(startInput.value);
            const endMin = timeToMinutes(endInput.value);
            if (startMin === null || endMin === null || endMin < startMin) {
                display.textContent = '--:--';
                return;
            }

            let pauseMinutes = 0;
            document.querySelectorAll('.pause-item').forEach(row => {
                const ps = row.querySelector('.pause-start');
                const pe = row.querySelector('.pause-end');
                const psMin = ps ? timeToMinutes(ps.value) : null;
                const peMin = pe ? timeToMinutes(pe.value) : null;
                if (psMin === null || peMin === null || peMin <= psMin) return;

                // Clamp pause to the work window
                const clampStart = Math.max(startMin, psMin);
                const clampEnd = Math.min(endMin, peMin);
                if (clampEnd > clampStart) {
                    pauseMinutes += (clampEnd - clampStart);
                }
            });

            const total = Math.max(0, (endMin - startMin) - pauseMinutes);
            const h = Math.floor(total / 60);
            const m = total % 60;
            display.textContent = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function formatTimeInput(inputEl) {
            const normalized = normalizeTimeInput(inputEl.value);
            if (normalized) {
                inputEl.value = normalized;
            }
        }

        async function updateStatus() {
            const select = document.getElementById('statusSelect');
            const status = select.value;
            const res = await fetch('/api/session/update_status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ session_id: SESSION_ID, status })
            });

            if (res.ok) {
                applyStatusUi(status);
            } else {
                alert('Failed to update status');
            }
        }

        applyStatusUi(INITIAL_STATUS);
        document.querySelectorAll('.time-text-input').forEach(input => {
            input.addEventListener('blur', () => formatTimeInput(input));
        });
        updateTotalWork();
    </script>
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>

</html>
